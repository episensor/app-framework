name: Framework CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # Single setup job that other jobs depend on
  setup:
    name: Setup & Cache Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Generate cache key
      id: cache-key
      run: echo "key=${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
        
    - name: Cache dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: |
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
          
    - name: Install dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: npm ci
      
    - name: Upload workspace for parallel jobs
      uses: actions/upload-artifact@v4
      with:
        name: workspace-deps
        path: |
          node_modules
          package.json
          package-lock.json
        retention-days: 1

  # Parallel quality checks
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        task: [lint, format, security]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace-deps
        
    - name: Run ${{ matrix.task }}
      run: |
        case "${{ matrix.task }}" in
          lint) npm run lint ;;
          format) npm run format:check ;;
          security) npm audit --audit-level moderate ;;
        esac

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    needs: setup
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20, 22]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-
          
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: |
        npm run test:unit
        npm run test:integration
      
    - name: Generate coverage report
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == env.NODE_VERSION
      run: npm run test:coverage -- --maxWorkers=1 --forceExit
      
    - name: Upload coverage
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == env.NODE_VERSION
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7

  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace-deps
      
    - name: Run security tests
      run: |
        npm run test:security || true
        npm run security:deps || true

  documentation:
    name: Documentation
    runs-on: ubuntu-latest
    needs: setup
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace-deps
      
    - name: Generate documentation
      run: |
        npm run docs:api || echo "API docs generation not configured"
        npm run docs:build || echo "Docs build not configured"
      
    - name: Upload docs artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/dist
        retention-days: 30

  build:
    name: Build & Package
    runs-on: ${{ matrix.os }}
    needs: [quality, test]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
          
    - name: Install dependencies
      run: npm ci
      
    - name: Build package
      run: |
        npm run build
        npm run build:ui
      
    - name: Verify build outputs
      shell: bash
      run: |
        if [ ! -d "ui/dist" ]; then
          echo "UI components not built! ui/dist directory missing"
          exit 1
        fi
        if [ ! -f "ui/dist/index.js" ]; then
          echo "UI components not properly built! index.js missing"
          exit 1
        fi
        echo "âœ“ Build outputs verified"
      
    - name: Package for distribution
      run: npm pack
      
    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: package-${{ matrix.os }}
        path: '*.tgz'
        retention-days: 30

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Download package artifact
      uses: actions/download-artifact@v4
      with:
        name: package-ubuntu-latest
        
    - name: Determine version bump
      id: version
      run: |
        COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n1)
        if [[ "$COMMIT_MSG" =~ ^BREAKING ]]; then
          echo "bump=major" >> $GITHUB_OUTPUT
        elif [[ "$COMMIT_MSG" =~ ^feat ]]; then
          echo "bump=minor" >> $GITHUB_OUTPUT
        else
          echo "bump=patch" >> $GITHUB_OUTPUT
        fi
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Bump version and commit
      id: bump
      run: |
        NEW_VERSION=$(npm version ${{ steps.version.outputs.bump }} --no-git-tag-version)
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        git add package.json package-lock.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git push
        
    - name: Create GitHub release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.bump.outputs.new_version }}
        name: Release ${{ steps.bump.outputs.new_version }}
        body: |
          ## Changes
          - Auto-generated release from CI/CD pipeline
          - Version bump: ${{ steps.version.outputs.bump }}
          
          ## Package
          - Framework package: episensor-app-framework-${{ steps.bump.outputs.new_version }}.tgz
          
        files: '*.tgz'
        draft: false
        prerelease: false

  # Cleanup job to remove artifacts after successful release
  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    
    steps:
    - name: Delete workspace artifact
      uses: geekyeggo/delete-artifact@v2
      with:
        name: workspace-deps
